<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InputToFood.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-spring-boot-kitchensink</a> &gt; <a href="index.source.html" class="el_package">com.example.bot.spring.controllers</a> &gt; <span class="el_source">InputToFood.java</span></div><h1>InputToFood.java</h1><pre class="source lang-java linenums">package com.example.bot.spring.controllers;

import com.example.bot.spring.tables.*;
import com.example.bot.spring.controllers.MenuController;

import java.util.*;
import java.util.function.*;
import java.io.File;
import java.io.IOException;
import java.text.ParseException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.client.RestTemplate;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpEntity;
import org.springframework.stereotype.Controller;
import org.springframework.stereotype.Service;
import com.example.bot.spring.models.Menu;
import com.example.bot.spring.models.OCRResponse;
import com.example.bot.spring.models.Response;
import com.example.bot.spring.models.TextAnnotation;
import com.example.bot.spring.KitchenSinkController.DownloadedContent;
import org.apache.commons.io.FileUtils;
import org.springframework.http.MediaType;

/** This controller takes in the menu inputs from the user, turn them into text, and then pass it to 
 *  MenuController to pick the food for the user. It also provides the details of the food that the 
 *  user has requested for.
 */

import lombok.extern.slf4j.Slf4j;

@Service

<span class="fc" id="L39">public class InputToFood {</span>
	@Autowired
	private FoodRepository foodRepository;
	
	@Autowired
	private MenuController menuController;
	
	/** This method reads the text menu passed in by the user and passes it to MenuController.
	 * 
	 * @param userId the ID of the user
	 * @param text the text menu passed in by the user
	 * @return the choice from the menu
	 */
    public String readFromText(String userId, String text) {
<span class="fc" id="L53">		menuController.setUserID(userId);</span>
<span class="fc" id="L54">		menuController.setMenu(text);</span>
<span class="fc" id="L55">    	return menuController.pickFood();</span>
    }

    /**
     * This method is used to convert JSON HTTP response to menu format.  
     * @param url URL to the JSON source
     * @return String Formatted String of the menu
     */
    public String readFromJSON(String url) {
<span class="fc bfc" id="L64" title="All 2 branches covered.">    	if (url == null) {</span>
<span class="fc" id="L65">    		return &quot;Invalid input&quot;;</span>
    	}
    	
    	try {
<span class="fc" id="L69">    		RestTemplate restTemplate = new RestTemplate();</span>
<span class="fc" id="L70">        	Menu[] menuList = restTemplate.getForObject(url, Menu[].class);</span>
<span class="fc" id="L71">        	StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L72">        	int counter = 1;</span>
<span class="fc" id="L73">        	builder.append(&quot;The Foods in each entree are as followed:\n&quot;);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        	for (Menu menu : menuList) {</span>
<span class="fc" id="L75">        		String[] ingredients = menu.getIngredients();</span>
<span class="fc" id="L76">        		builder.append(counter);</span>
<span class="fc" id="L77">        		builder.append(&quot;. &quot;);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        		for (String ingredient : ingredients) {</span>
<span class="fc" id="L79">        			builder.append(ingredient);</span>
<span class="fc" id="L80">        			builder.append(&quot;, &quot;);</span>
        		}
<span class="fc" id="L82">        		counter++;</span>
<span class="fc" id="L83">        		builder.append(&quot;\n&quot;);</span>
        	}
<span class="fc" id="L85">        	builder.deleteCharAt(builder.length() - 1);</span>
        	
<span class="fc" id="L87">        	return builder.toString();</span>
<span class="fc" id="L88">    	} catch (Exception e) {</span>
<span class="fc" id="L89">    		e.printStackTrace();</span>
<span class="fc" id="L90">    		return &quot;Failed to load URL.&quot;;</span>
    	}
    }

    /**
     * This method uses OCR feature of the Google Vision API to extract menu String
     * from the image uploaded by the user through Line
     * @param jpeg DownloadedContent instance of the image file uploaded by the user
     * @return String Menu String processed from the image using Google Vision API
     */
    public String readFromJPEG(DownloadedContent jpeg) {
<span class="pc bpc" id="L101" title="1 of 6 branches missed.">    	if (jpeg == null || jpeg.getPath() == null || jpeg.getUri() == null) {</span>
<span class="fc" id="L102">    		return &quot;Invalid input&quot;;</span>
    	}
    	
<span class="fc" id="L105">    	String menu = &quot;&quot;;</span>
<span class="fc" id="L106">    	RestTemplate restTemplate = new RestTemplate();</span>
<span class="fc" id="L107">    	String apiKey = &quot;AIzaSyCrPOUDlYLaAQLAXbFSiRgb16OSikBooP8&quot;;</span>
<span class="fc" id="L108">    	String url = &quot;https://vision.googleapis.com/v1/images:annotate?key=&quot; + apiKey;</span>
<span class="fc" id="L109">    	String json = buildJson(jpeg);</span>
<span class="fc" id="L110">    	HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L111">    	headers.setContentType(MediaType.APPLICATION_JSON);</span>

<span class="fc" id="L113">    	HttpEntity&lt;String&gt; entity = new HttpEntity&lt;String&gt;(json, headers);</span>
<span class="fc" id="L114">    	OCRResponse ocrResponse = restTemplate.postForObject(url, entity, OCRResponse.class);</span>
<span class="fc" id="L115">    	Response response = ocrResponse.getResponses()[0];</span>
<span class="fc" id="L116">    	TextAnnotation textAnnotation = response.getTextAnnotations()[0];</span>
<span class="fc" id="L117">    	menu = textAnnotation.getDescription();</span>
<span class="fc" id="L118">    	String[] menuList = menu.split(&quot;\\r?\\n&quot;);</span>
<span class="fc" id="L119">    	StringBuilder builder = new StringBuilder();</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">    	for (String m : menuList) {</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">    		if (!isNumeric(m)) {</span>
<span class="fc" id="L122">    			builder.append(m);</span>
<span class="fc" id="L123">    			builder.append(&quot;\n&quot;);</span>
    		}
    	}
    	
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">    	if (builder.length() &gt; 1) {</span>
<span class="fc" id="L128">    		builder.deleteCharAt(builder.length() - 1);</span>
    	}
    	
<span class="fc" id="L131">    	return builder.toString();</span>
    }
    
    /** This method builds the menu in JSON format from a picture of the menu
     * 
     * @param jpeg the picture of the menu
     * @return the JSON format of the menu
     */
    private String buildJson(DownloadedContent jpeg) {
    	try {
<span class="fc" id="L141">    		StringBuilder jsonBuilder = new StringBuilder();</span>
<span class="fc" id="L142">        	File file = jpeg.getPath().toFile();</span>
<span class="fc" id="L143">        	String imageCode = Base64.getEncoder().encodeToString(FileUtils.readFileToByteArray(file));</span>
<span class="fc" id="L144">        	jsonBuilder.append(&quot;{\&quot;requests\&quot;:[&quot;);</span>
<span class="fc" id="L145">        	jsonBuilder.append(&quot;{\&quot;image\&quot;:{&quot;);</span>
<span class="fc" id="L146">        	jsonBuilder.append(&quot;\&quot;content\&quot;:\&quot;&quot;);</span>
<span class="fc" id="L147">        	jsonBuilder.append(imageCode);</span>
<span class="fc" id="L148">        	jsonBuilder.append(&quot;\&quot;},&quot;);</span>
<span class="fc" id="L149">        	jsonBuilder.append(&quot;\&quot;features\&quot;:[{&quot;);</span>
<span class="fc" id="L150">        	jsonBuilder.append(&quot;\&quot;type\&quot;:\&quot;TEXT_DETECTION\&quot;&quot;);</span>
<span class="fc" id="L151">        	jsonBuilder.append(&quot;}]&quot;);</span>
<span class="fc" id="L152">        	jsonBuilder.append(&quot;}&quot;);</span>
<span class="fc" id="L153">        	jsonBuilder.append(&quot;]}&quot;);</span>
<span class="fc" id="L154">        	return jsonBuilder.toString();</span>
<span class="nc" id="L155">    	} catch (IOException e) {</span>
<span class="nc" id="L156">    		e.printStackTrace();</span>
<span class="nc" id="L157">    		return &quot;&quot;;</span>
    	}
    }
    
    /** This method returns the details of the food that the user requested.
     * 
     * @param food the name of the food the user requested
     * @return the details of the food
     */
    public String getFoodDetails(String food) {
<span class="pc bpc" id="L167" title="2 of 4 branches missed.">    		if(food == null || food == &quot;&quot;) {</span>
<span class="nc" id="L168">    			return &quot;You have not entered any food&quot;;</span>
    		}
    		
<span class="fc" id="L171">    		String resultFood = &quot;You have entered &quot; + food + &quot;.\n&quot;;</span>
<span class="fc" id="L172">    		String[] splitFood = food.split(&quot;\\s+&quot;);</span>
    		
<span class="fc bfc" id="L174" title="All 2 branches covered.">	    	for (int i = 0; i &lt; splitFood.length; i++) {	</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">	    		for (Food fd : foodRepository.findAll()) {</span>
<span class="fc" id="L176">	    		    String fdName = fd.getName().toLowerCase();</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">	            	if (fdName.contains(&quot;,&quot;)) {</span>
<span class="nc" id="L178">	            		fdName = fdName.substring(0,fdName.indexOf(&quot;,&quot;));</span>
	            	}
	            	
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">	            	if (fdName.endsWith(&quot;s&quot;)) {</span>
<span class="nc" id="L182">	            		fdName = fdName.substring(0, fdName.length()-1);</span>
	            	}
	            	
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">	    		    if (splitFood[i].toLowerCase().contains(fdName)) { </span>
<span class="fc" id="L186">	    		    		resultFood += &quot;Here are the details for &quot; + fdName + &quot;\n&quot; + fd.getDetails() + &quot;\n&quot; + &quot;\n&quot;;</span>
<span class="fc" id="L187">	    		    		break;</span>
	    		    }
<span class="nc" id="L189">	    		}</span>
	    	}
    		
<span class="fc" id="L192">    		return resultFood;</span>
    }
    
    /**
     * Helper method to check if the given String is numeric
     * @param str String to test
     * @return True if the String is numeric; false otherwise
     */
    private boolean isNumeric(String str) {
<span class="fc" id="L201">      return str.matches(&quot;-?\\d+(\\.\\d+)?&quot;);  //match a number with optional '-' and decimal.</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>